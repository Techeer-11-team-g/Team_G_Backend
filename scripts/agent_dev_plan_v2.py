#!/usr/bin/env python3
"""
AI 패션 어시스턴트 에이전트 시스템 - 개발 계획서 v2
현재 프로젝트 기능 기반 - 모든 처리 가능 Edge Case 포함
"""

from docx import Document
from docx.shared import Pt, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH
import os


def add_table(doc, title, data, headers, level=3):
    if title:
        doc.add_heading(title, level=level)
    table = doc.add_table(rows=len(data)+1, cols=len(headers))
    table.style = 'Table Grid'
    for i, h in enumerate(headers):
        cell = table.rows[0].cells[i]
        cell.text = h
        for paragraph in cell.paragraphs:
            for run in paragraph.runs:
                run.bold = True
    for i, row in enumerate(data, 1):
        for j, val in enumerate(row):
            table.rows[i].cells[j].text = str(val)
    doc.add_paragraph()


def add_code_block(doc, code, title=None):
    if title:
        p = doc.add_paragraph()
        run = p.add_run(title)
        run.bold = True
    p = doc.add_paragraph()
    p.style = 'No Spacing'
    run = p.add_run(code)
    run.font.name = 'Consolas'
    run.font.size = Pt(9)
    doc.add_paragraph()


def create_dev_plan_v2():
    doc = Document()
    style = doc.styles['Normal']
    style.font.name = 'Malgun Gothic'
    style.font.size = Pt(9)

    # ================================================================
    # 표지
    # ================================================================
    title = doc.add_heading('AI 패션 어시스턴트', level=0)
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER
    doc.add_paragraph('에이전트 기반 시스템 개발 계획서 v2.0').alignment = WD_ALIGN_PARAGRAPH.CENTER
    doc.add_paragraph()
    doc.add_paragraph('현재 구현 기능 기반 - 전체 Edge Case 포함 (350+)')
    doc.add_paragraph('Team_G Backend 프로젝트')
    doc.add_paragraph('작성일: 2026-01-20')
    doc.add_page_break()

    # ================================================================
    # 현재 기능 범위 정의
    # ================================================================
    doc.add_heading('1. 현재 구현 기능 범위', level=1)

    doc.add_heading('1.1 지원 기능 목록', level=2)

    add_table(doc, '', [
        ('이미지 분석', 'Google Vision API', '상의/하의/아우터/신발/가방/모자/치마', '✅'),
        ('속성 추출', 'Claude Vision', '색상/소재/스타일/핏/패턴/브랜드/기장', '✅'),
        ('벡터 검색', 'OpenSearch k-NN', 'FashionCLIP 512차원 + 하이브리드', '✅'),
        ('자연어 재분석', 'LangChain', '다중 카테고리, 필터 조합', '✅'),
        ('가상 피팅', 'The New Black', '상의/하의/드레스/신발/가방', '✅'),
        ('장바구니', 'CartItem 모델', '추가/삭제/수량변경/조회', '✅'),
        ('주문', 'Order 모델', '생성/취소/상태조회', '✅'),
        ('상태관리', 'Redis', '분석/피팅/재분석 상태, 대화이력', '✅'),
    ], ['기능', '기술', '범위', '상태'])

    doc.add_heading('1.2 지원 속성 (Refine 필터)', level=2)

    add_table(doc, '', [
        ('color_filter', '색상', 'black/white/navy/blue/red/green/...'),
        ('pattern_filter', '패턴', 'solid/stripe/check/floral/dot/...'),
        ('style_vibe', '스타일', 'casual/formal/sporty/minimal/...'),
        ('brand_filter', '브랜드', 'nike/adidas/zara/uniqlo/...'),
        ('material_filter', '소재', 'leather/denim/cotton/linen/...'),
        ('fit_filter', '핏', 'slim/regular/oversized/loose'),
        ('sleeve_length', '소매', 'long_sleeve/short_sleeve/sleeveless'),
        ('pants_length', '바지기장', 'long/shorts/cropped'),
        ('outer_length', '아우터기장', 'long/regular/cropped'),
        ('price_sort', '가격정렬', 'lowest/highest'),
    ], ['필터', '설명', '값'])

    doc.add_page_break()

    # ================================================================
    # SECTION A: 입력 처리 Edge Cases (현재 기능 범위)
    # ================================================================
    doc.add_heading('2. Edge Case 처리 계획 - 입력', level=1)

    doc.add_heading('2.1 텍스트 입력 - 카테고리', level=2)

    add_table(doc, '지원 카테고리 (7종)', [
        ('상의', '"셔츠", "티셔츠", "블라우스", "니트"', 'top', 'Search Agent'),
        ('하의', '"바지", "청바지", "슬랙스", "치마"', 'bottom', 'Search Agent'),
        ('아우터', '"자켓", "코트", "패딩", "가디건"', 'outer', 'Search Agent'),
        ('신발', '"운동화", "구두", "부츠", "샌들"', 'shoes', 'Search Agent'),
        ('가방', '"백팩", "토트백", "크로스백"', 'bag', 'Search Agent'),
        ('모자', '"캡", "비니", "버킷햇"', 'hat', 'Search Agent'),
        ('복수카테고리', '"상의랑 바지", "전체코디"', 'multiple', 'Search Agent (다중)'),
    ], ['카테고리', '예시 입력', '코드', '처리 에이전트'])

    add_table(doc, '미지원/모호 카테고리 처리 (13종)', [
        ('악세서리', '"시계", "목걸이"', '미지원 안내 + 대안'),
        ('언더웨어', '"속옷", "양말"', '미지원 안내'),
        ('수영복', '"비키니", "래쉬가드"', '미지원 안내'),
        ('정장세트', '"수트", "정장"', '개별 검색 유도'),
        ('한복', '"한복"', '미지원 안내'),
        ('모호', '"뭐 없어?", "입을 거"', '카테고리 질문'),
        ('신조어', '"갬성템"', 'LLM 해석 시도'),
        ('외래어', '"tops", "bottoms"', '영문 매핑'),
        ('복합', '"상하의 세트"', '다중 검색'),
        ('비유', '"위에 입는 거"', '카테고리 추정'),
        ('브랜드포함', '"나이키 신발"', '브랜드+카테고리 분리'),
        ('계절포함', '"여름 바지"', '계절+카테고리 분리'),
        ('TPO포함', '"출근용 셔츠"', 'TPO+카테고리 분리'),
    ], ['유형', '예시', '처리'])

    doc.add_heading('2.2 텍스트 입력 - 색상', level=2)

    add_table(doc, '색상 필터 (25종)', [
        ('기본색', '검정/흰색/빨강/파랑/노랑/초록', 'color_filter 직접 매핑'),
        ('세부색', '네이비/버건디/카키/베이지/아이보리', 'color_filter 매핑'),
        ('톤', '"밝은 파랑", "진한 빨강"', 'LLM 해석 → 기본색'),
        ('계절톤', '"봄컬러", "가을웜톤"', 'LLM 해석 → 복수 색상'),
        ('비유', '"하늘색", "살구색", "와인색"', 'LLM 매핑'),
        ('복합', '"투톤", "그라데이션"', '검색어로 전달'),
        ('제외', '"검정 말고", "흰색 빼고"', '제외 필터'),
        ('범위', '"블루계열"', '복수 색상 OR'),
        ('브랜드색', '"티파니블루"', 'LLM 해석'),
        ('오타', '"겁정", "파랑ㅅ"', '자동 교정'),
        ('영문', '"black", "white"', '영문 매핑'),
        ('혼용', '"블랙색", "화이트색"', '정규화'),
    ], ['유형', '예시', '처리'])

    doc.add_heading('2.3 텍스트 입력 - 브랜드', level=2)

    add_table(doc, '브랜드 필터 (15종)', [
        ('정확', '"나이키", "아디다스"', 'brand_filter 직접'),
        ('약어', '"나키", "아디", "유니클"', 'LLM 정규화'),
        ('오타', '"나이게", "아디디스"', 'LLM 교정'),
        ('영문', '"Nike", "ZARA"', '대소문자 무시'),
        ('서브브랜드', '"나이키 조던"', '브랜드+라인 분리'),
        ('콜라보', '"나이키x오프화이트"', '검색어 전달'),
        ('그룹', '"스포츠브랜드"', 'LLM → 복수 브랜드'),
        ('가격대', '"저가 브랜드"', 'LLM → 복수 브랜드'),
        ('복수', '"나이키나 아디다스"', 'OR 검색'),
        ('제외', '"나이키 말고"', '제외 필터'),
        ('모호', '"그 브랜드", "유명한 거"', '컨텍스트/질문'),
        ('국가', '"일본 브랜드"', 'LLM → 복수 브랜드'),
        ('미지원', '등록 안 된 브랜드', '검색어로 전달'),
    ], ['유형', '예시', '처리'])

    doc.add_heading('2.4 텍스트 입력 - 스타일/속성', level=2)

    add_table(doc, '스타일 필터 (30종)', [
        ('기본', '"캐주얼", "포멀", "스포티"', 'style_vibe 직접'),
        ('트렌드', '"Y2K", "고프코어", "올드머니"', 'LLM 해석'),
        ('감성', '"힙한", "시크한", "큐트한"', 'LLM → style_vibe'),
        ('TPO', '"출근룩", "데이트룩", "면접"', 'LLM → style_vibe'),
        ('활동', '"등산복", "러닝복"', 'LLM → style + category'),
        ('체형', '"마른 사람용", "키작은 사람"', 'LLM → fit 조정'),
        ('복합', '"캐주얼하면서 세련된"', 'LLM 복합 해석'),
        ('부정', '"촌스럽지 않은"', 'LLM 반전 해석'),
        ('비유', '"연예인 스타일"', 'LLM 해석'),
        ('계절', '"여름용", "겨울용"', 'LLM → 속성 조합'),
    ], ['유형', '예시', '처리'])

    add_table(doc, '상세 속성 필터 (20종)', [
        ('핏', '"슬림", "오버핏", "루즈"', 'fit_filter'),
        ('소매', '"긴팔", "반팔", "민소매"', 'sleeve_length'),
        ('바지기장', '"롱", "숏", "7부"', 'pants_length'),
        ('아우터기장', '"롱코트", "숏자켓"', 'outer_length'),
        ('소재', '"면", "린넨", "가죽", "데님"', 'material_filter'),
        ('패턴', '"무지", "스트라이프", "체크"', 'pattern_filter'),
        ('두께', '"얇은", "두꺼운", "기모"', 'LLM → 검색어'),
        ('계절', '"사계절", "여름용"', 'LLM → 속성 조합'),
        ('기능', '"방수", "속건"', 'LLM → 검색어'),
        ('복합', '"슬림핏 긴팔 면셔츠"', '다중 필터 적용'),
    ], ['속성', '예시', '처리'])

    doc.add_heading('2.5 텍스트 입력 - 가격', level=2)

    add_table(doc, '가격 조건 (10종)', [
        ('상한', '"5만원 이하", "10만원 미만"', 'price_max 필터'),
        ('하한', '"3만원 이상"', 'price_min 필터'),
        ('범위', '"3~5만원"', 'price_min + price_max'),
        ('상대', '"저렴한", "비싼"', 'price_sort'),
        ('정렬', '"싼 순", "비싼 순"', 'price_sort'),
        ('모호', '"적당한", "합리적인"', '기본 정렬'),
        ('단위', '"만원", "천원"', 'LLM 파싱'),
        ('외화', '"100달러"', 'LLM 환산'),
        ('비교', '"이것보다 싼"', '참조 가격 기준'),
        ('미지원', '할인/쿠폰 조건', '미지원 안내'),
    ], ['유형', '예시', '처리'])

    doc.add_page_break()

    # ================================================================
    # SECTION B: 이미지 입력 Edge Cases
    # ================================================================
    doc.add_heading('2.6 이미지 입력 - 유형', level=2)

    add_table(doc, '이미지 유형 (30종)', [
        ('전신착장', '전신+옷', 'Google Vision 객체 감지', 'Search Agent'),
        ('반신', '상반신/하반신', '보이는 영역 분석', 'Search Agent'),
        ('거울셀카', '좌우 반전', '자동 보정 후 분석', 'Search Agent'),
        ('상품단독', '옷만 있는 사진', '직접 분석', 'Search Agent'),
        ('평면배치', 'Flat lay', '각 객체별 분석', 'Search Agent'),
        ('옷걸이', '걸린 상태', '상품 분석', 'Search Agent'),
        ('스크린샷', '쇼핑몰 캡처', '상품 영역 추출', 'Search Agent'),
        ('SNS', '인스타/핀터레스트', '스타일 분석', 'Search Agent'),
        ('그룹사진', '여러 사람', '선택 요청', '확인 질문'),
        ('크롭사진', '일부만 보임', '보이는 부분 분석', 'Search Agent'),
        ('디테일', '클로즈업', '부분 기반 검색', 'Search Agent'),
        ('뒷모습/측면', '후면/옆면', '해당 각도 분석', 'Search Agent'),
        ('코디사진', '여러 아이템', '각각 분석', 'Search Agent'),
        ('리뷰사진', '구매후기', '상품 식별', 'Search Agent'),
    ], ['유형', '설명', '처리', '에이전트'])

    add_table(doc, '이미지 품질 문제 (20종)', [
        ('저해상도', '<100px', '재업로드 요청', 'P0'),
        ('고해상도', '>10MB', '서버 리사이즈', 'P0'),
        ('흐릿함', '초점 불량', '분석 시도 + 안내', 'P2'),
        ('어두움', '조명 부족', '보정 시도', 'P2'),
        ('필터', '색상 왜곡', '원본 색상 추정', 'P2'),
        ('워터마크', '로고 삽입', '워터마크 제외 분석', 'P2'),
        ('손상', '읽기 불가', '재업로드 요청', 'P0'),
        ('미지원형식', 'GIF/BMP/TIFF', '형식 안내', 'P0'),
        ('회전', '90/180/270도', '자동 보정', 'P2'),
        ('흑백', '컬러 없음', '색상 필터 제외', 'P2'),
        ('중복', '같은 이미지', '캐시 활용', 'P3'),
    ], ['문제', '설명', '처리', '우선순위'])

    add_table(doc, '이미지 내용 문제 (15종)', [
        ('패션없음', '풍경/음식/동물', '패션 아이템 필요 안내', 'P0'),
        ('부적절', 'NSFW', '거부 + 안내', 'P0'),
        ('다중인물', '여러 사람', '선택 요청', 'P1'),
        ('가려짐', '물체에 가림', '보이는 부분 분석', 'P2'),
        ('복잡배경', '산만한 배경', '객체 분리', 'P2'),
        ('텍스트만', '글자 이미지', '안내', 'P1'),
        ('로고/아이콘', '심볼', '안내', 'P1'),
    ], ['문제', '설명', '처리', '우선순위'])

    doc.add_page_break()

    # ================================================================
    # SECTION C: 복합 입력 Edge Cases
    # ================================================================
    doc.add_heading('2.7 복합 입력 (이미지 + 텍스트)', level=2)

    add_table(doc, '복합 입력 시나리오 (20종)', [
        ('유사검색', '이미지 + "비슷한 거"', '이미지 기반 k-NN', 'Search'),
        ('크로스추천', '이미지 + "어울리는 바지"', '크로스 카테고리 검색', 'Search'),
        ('색상변경', '이미지 + "검정으로"', '이미지 분석 + 색상 필터', 'Search'),
        ('브랜드변경', '이미지 + "나이키로"', '이미지 분석 + 브랜드 필터', 'Search'),
        ('가격변경', '이미지 + "더 싸게"', '이미지 분석 + 가격 정렬', 'Search'),
        ('분석요청', '이미지 + "분석해줘"', '속성 추출 반환', 'Search'),
        ('피팅요청', '이미지 + "입어볼래"', '이미지 분석 → 피팅', 'Search → Fitting'),
        ('구매요청', '이미지 + "살래"', '이미지 분석 → 구매', 'Search → Commerce'),
        ('비교', '2개 이미지 + "비교"', '각각 분석 후 비교', 'Search (비교모드)'),
        ('조합확인', '2개 이미지 + "어울려?"', '컬러 매칭 분석', 'Search (분석)'),
        ('부분추출', '이미지 + "상의만"', '특정 객체만 검색', 'Search'),
        ('제외검색', '이미지 + "이거 말고"', '유사 검색 + 제외', 'Search'),
    ], ['시나리오', '입력', '처리', '에이전트'])

    add_table(doc, '상충/모순 입력 (10종)', [
        ('색상불일치', '빨간 옷 이미지 + "파란 옷"', '확인 질문'),
        ('카테고리불일치', '바지 이미지 + "셔츠"', '확인 질문'),
        ('스타일불일치', '캐주얼 + "정장"', '확인 질문'),
        ('무관이미지', '풍경 + "바지 찾아"', '이미지 무시 + 텍스트 검색'),
        ('반대요청', '이미지 + "이거 말고"', '제외 검색'),
        ('참조없음', '"아까 거" (없음)', '안내'),
    ], ['상충', '예시', '처리'])

    doc.add_page_break()

    # ================================================================
    # SECTION D: 대화 컨텍스트 Edge Cases
    # ================================================================
    doc.add_heading('3. Edge Case 처리 계획 - 대화 컨텍스트', level=1)

    doc.add_heading('3.1 참조 표현', level=2)

    add_table(doc, '직접 참조 (15종)', [
        ('"이거"', '현재 표시 항목', 'context.current_item', 'P1'),
        ('"그거"', '직전 항목', 'context.last_item', 'P1'),
        ('"첫번째"/"1번"', '인덱스 참조', 'context.search_results[0]', 'P1'),
        ('"마지막"', '마지막 항목', 'context.search_results[-1]', 'P1'),
        ('"빨간 거"', '속성 참조', 'filter by color', 'P1'),
        ('"싼 거"', '조건 참조', 'sort by price', 'P1'),
        ('"나이키 거"', '브랜드 참조', 'filter by brand', 'P1'),
        ('"참조없음"', '컨텍스트에 없음', '명확화 질문', 'P1'),
    ], ['표현', '의미', '처리', '우선순위'])

    add_table(doc, '시간 참조 (10종)', [
        ('"아까"', '세션 내 이전', 'conversation_history 조회', 'P1'),
        ('"방금"', '직전 턴', 'last_turn', 'P1'),
        ('"처음에"', '세션 시작', 'first_search_results', 'P2'),
        ('"어제"/"지난번"', '이전 세션', '세션 범위 외 안내', 'P2'),
    ], ['표현', '의미', '처리', '우선순위'])

    add_table(doc, '상태 참조 (8종)', [
        ('"검색한 거"', '검색 결과', 'context.search_results', 'P1'),
        ('"피팅한 거"', '피팅 결과', 'context.fitting_results', 'P1'),
        ('"담은 거"', '장바구니', 'CartItem.objects.filter(user)', 'P1'),
        ('"주문한 거"', '주문 이력', 'Order.objects.filter(user)', 'P1'),
        ('"찜한 거"', '위시리스트', '미지원 안내', 'P3'),
    ], ['표현', '의미', '처리', '우선순위'])

    add_table(doc, '복잡한 참조 체인 (8종)', [
        ('"아까 그거에서 색만 바꾼"', '참조 + 수정', '이전 결과 + 색상 필터', 'P2'),
        ('"처음 본 거랑 비슷한데 더 싼"', '참조 + 조건', '이전 결과 기반 + 가격 조건', 'P2'),
        ('"그 중에서 2번"', '참조 + 인덱싱', '이전 결과 + 인덱스', 'P1'),
        ('"아까 피팅한 것 중 검정"', '참조 + 필터', '피팅 결과 + 색상 필터', 'P2'),
    ], ['표현', '의미', '처리', '우선순위'])

    doc.add_heading('3.2 멀티턴 대화', level=2)

    add_table(doc, '대화 패턴 (15종)', [
        ('필터 누적', '"바지" → "검정" → "슬림"', '조건 순차 추가', 'P1'),
        ('조건 교체', '"검정" → "아니 네이비"', '이전 조건 교체', 'P1'),
        ('주제 전환', '"바지" → "신발도"', '새 카테고리 추가', 'P1'),
        ('되돌아가기', '"아까 바지로"', '이전 상태 복원', 'P2'),
        ('선택 연속', '"1번" → "그거 피팅"', '선택 상태 유지', 'P1'),
        ('부정 누적', '"이거 말고" → "저것도"', '제외 목록 누적', 'P2'),
        ('결과 좁히기', '"이 중에서 무지만"', '현재 결과 필터', 'P1'),
        ('결과 넓히기', '"비슷한 것도"', '조건 완화', 'P2'),
        ('수정', '"아니 그게 아니라"', '이전 해석 취소', 'P2'),
        ('확인', '"이게 맞아?"', '확정 요청', 'P1'),
        ('반복', '"다시 보여줘"', '이전 결과 재표시', 'P2'),
        ('비교 전환', '"이거랑 저거"', '비교 모드 전환', 'P1'),
        ('피팅 전환', '"입어볼래"', '피팅 모드 전환', 'P1'),
        ('구매 전환', '"살래"', '구매 모드 전환', 'P1'),
        ('종료', '"됐어", "끝"', '대화 종료', 'P2'),
    ], ['패턴', '예시', '처리', '우선순위'])

    add_table(doc, '조건부 요청 (10종)', [
        ('"있으면 담아줘"', '존재 확인 후 담기', '검색 → 확인 → 장바구니', 'P1'),
        ('"없으면 비슷한 거"', '대안 요청', '검색 → 폴백', 'P2'),
        ('"L 있으면"', '사이즈 확인', '사이즈 조회 → 조건 처리', 'P1'),
        ('"싸면 살게"', '가격 조건', '가격 확인 → 조건 처리', 'P2'),
        ('"괜찮으면 주문"', '사용자 확인', '확인 후 주문', 'P1'),
    ], ['조건', '의미', '처리', '우선순위'])

    doc.add_page_break()

    # ================================================================
    # SECTION E: 기능별 Edge Cases
    # ================================================================
    doc.add_heading('4. Edge Case 처리 계획 - 기능별', level=1)

    doc.add_heading('4.1 Search Agent 시나리오', level=2)

    add_table(doc, '검색 수정 (12종)', [
        ('결과 좁히기', '"이 중에서 무지만"', '현재 결과 + 필터', 'P1'),
        ('결과 넓히기', '"비슷한 것도"', '조건 완화 재검색', 'P2'),
        ('재검색', '"다시 찾아줘"', '동일 조건 재검색', 'P2'),
        ('조건 추가', '"면 소재로"', '필터 추가', 'P1'),
        ('조건 제거', '"색상 빼고"', '필터 제거', 'P2'),
        ('조건 교체', '"검정 말고 네이비"', '필터 교체', 'P1'),
        ('정렬 변경', '"싼 순으로"', 'price_sort 변경', 'P1'),
        ('개수 변경', '"더 많이"', 'limit 증가', 'P2'),
        ('페이지', '"다음", "더보기"', '페이지네이션', 'P2'),
        ('이전 결과', '"아까 결과로"', '상태 복원', 'P2'),
        ('초기화', '"조건 다 빼고"', '필터 리셋', 'P2'),
    ], ['동작', '예시', '처리', '우선순위'])

    doc.add_heading('4.2 Fitting Agent 시나리오', level=2)

    add_table(doc, '피팅 요청 유형 (15종)', [
        ('단일 피팅', '"이거 입어볼래"', '단일 상품 피팅', 'P1'),
        ('번호 지정', '"1번 피팅"', '인덱스 → 상품 → 피팅', 'P1'),
        ('전체 피팅', '"다 입어봐"', '배치 피팅 (병렬)', 'P1'),
        ('선택 피팅', '"1, 3번만"', '선택 상품 배치', 'P1'),
        ('비교 피팅', '"둘 다 입어서 비교"', '비교 모드 피팅', 'P1'),
        ('다른 색상', '"검정으로 피팅"', '색상 변형 검색 → 피팅', 'P2'),
        ('다른 사이즈', '"L로 피팅"', '사이즈는 피팅에 미적용 (안내)', 'P2'),
        ('재피팅', '"다시"', '동일 조건 재요청', 'P2'),
        ('추가 피팅', '"이것도"', '기존 결과에 추가', 'P2'),
        ('제외 피팅', '"이거 빼고"', '특정 상품 제외', 'P2'),
    ], ['유형', '예시', '처리', '우선순위'])

    add_table(doc, '피팅 전제조건/에러 (10종)', [
        ('이미지 없음', '전신 이미지 미등록', '업로드 안내', 'P0'),
        ('상품 없음', '검색 안 함', '검색 유도', 'P0'),
        ('카테고리 불가', '액세서리 피팅', '미지원 안내', 'P1'),
        ('이미지 부적합', '얼굴만', '전신 요청', 'P1'),
        ('진행 중', '중복 요청', '대기 안내', 'P1'),
        ('API 한도', '일일 한도 초과', '한도 안내', 'P1'),
        ('API 오류', '서버 오류', '재시도 → 에러', 'P0'),
        ('타임아웃', '시간 초과', '비동기 처리 안내', 'P1'),
        ('부분 실패', '일부 상품만 성공', '성공 분만 반환', 'P2'),
    ], ['상황', '설명', '처리', '우선순위'])

    doc.add_heading('4.3 Commerce Agent 시나리오', level=2)

    add_table(doc, '사이즈 추천 (18종)', [
        ('추천 요청', '"사이즈 뭐가 좋아?"', '프로필 기반 추천', 'P1'),
        ('신체 정보', '"175cm 70kg"', '정보 저장 + 추천', 'P1'),
        ('평소 사이즈', '"보통 L 입어"', '이력 저장 + 추천', 'P1'),
        ('브랜드별', '"이 브랜드 사이즈?"', '브랜드 가이드 참조', 'P2'),
        ('비교', '"M이랑 L 차이"', '비교표 제공', 'P2'),
        ('재고 확인', '"L 있어?"', 'SizeCode 조회', 'P1'),
        ('핏 선호', '"넉넉하게"', '사이즈업 추천', 'P2'),
        ('체형', '"어깨 넓어"', '보정 추천', 'P2'),
        ('과거 경험', '"전에 M 샀는데 작았어"', '이력 반영', 'P2'),
        ('정보 없음', '프로필 미입력', '정보 요청', 'P1'),
    ], ['상황', '예시', '처리', '우선순위'])

    add_table(doc, '장바구니 관리 (15종)', [
        ('추가', '"담아줘"', 'CartItem 생성', 'P1'),
        ('번호 지정', '"1번 담아"', '인덱스 → 장바구니', 'P1'),
        ('복수 추가', '"1, 3번 담아"', '다중 CartItem', 'P1'),
        ('사이즈 지정', '"L로 담아"', 'SizeCode 지정', 'P1'),
        ('수량 지정', '"2개 담아"', 'quantity 지정', 'P1'),
        ('전체 옵션', '"검정 L 2개"', '전체 옵션 파싱', 'P1'),
        ('조회', '"장바구니"', 'CartItem 목록', 'P1'),
        ('삭제', '"빼줘"', 'soft delete', 'P1'),
        ('전체 삭제', '"비워줘"', '전체 soft delete', 'P1'),
        ('수량 변경', '"3개로"', 'quantity 업데이트', 'P1'),
        ('사이즈 변경', '"M으로"', 'SizeCode 변경', 'P1'),
        ('합계', '"총 얼마?"', '가격 계산', 'P1'),
        ('중복 상품', '이미 있는 상품', '수량 확인', 'P2'),
        ('품절', '재고 없음', '대안 안내', 'P0'),
    ], ['동작', '예시', '처리', '우선순위'])

    add_table(doc, '주문 관리 (15종)', [
        ('주문', '"주문할게"', 'Order 생성', 'P1'),
        ('즉시 구매', '"바로 살게"', '장바구니 없이 주문', 'P1'),
        ('일부 주문', '"1번만 주문"', '선택 상품만', 'P2'),
        ('주문 확인', '"주문 내역"', 'Order 목록', 'P1'),
        ('배송 상태', '"배송 어디?"', 'OrderItem 상태', 'P1'),
        ('취소', '"취소해줘"', 'Order 취소', 'P1'),
        ('취소 불가', '배송 시작 후', '상태 안내', 'P1'),
        ('빈 장바구니', '장바구니 비어있음', '안내', 'P1'),
    ], ['동작', '예시', '처리', '우선순위'])

    doc.add_page_break()

    # ================================================================
    # SECTION F: 시스템 에러 Edge Cases
    # ================================================================
    doc.add_heading('5. Edge Case 처리 계획 - 시스템 에러', level=1)

    doc.add_heading('5.1 API 에러', level=2)

    add_table(doc, 'API 에러 처리 (15종)', [
        ('Vision 타임아웃', '30초 초과', '재시도 3회 → 에러', 'P0'),
        ('Vision 실패', '500 에러', '재시도 3회 → 에러', 'P0'),
        ('Claude 실패', 'API 오류', 'GPT 폴백 → 기본값', 'P0'),
        ('Claude Rate Limit', '한도 초과', '대기 → 재시도', 'P0'),
        ('OpenSearch 실패', '검색 오류', '필터 기반 폴백', 'P0'),
        ('피팅 API 실패', 'The New Black 오류', '재시도 3회', 'P0'),
        ('피팅 타임아웃', '120초 초과', '비동기 안내', 'P1'),
        ('GCS 실패', '업로드 오류', '재시도', 'P0'),
        ('Redis 연결 끊김', '세션 로드 실패', '새 세션', 'P0'),
        ('DB 오류', '쿼리 실패', '재시도 → 에러', 'P0'),
    ], ['에러', '상황', '처리', '우선순위'])

    doc.add_heading('5.2 비즈니스 에러', level=2)

    add_table(doc, '비즈니스 에러 처리 (15종)', [
        ('품절', '재고 없음', '대안 추천', 'P0'),
        ('사이즈 품절', '특정 사이즈 없음', '다른 사이즈 안내', 'P0'),
        ('상품 삭제', '상품 없음', '대안 추천', 'P1'),
        ('가격 변동', '조회 vs 주문', '최신 가격 적용', 'P1'),
        ('주문 취소 불가', '배송 시작 후', '상태 안내', 'P1'),
        ('결제 실패', '카드 오류', '다른 수단 안내', 'P0'),
        ('권한 없음', '로그인 필요', '로그인 유도', 'P1'),
        ('한도 초과', '일일 한도', '안내', 'P1'),
        ('잘못된 입력', '유효하지 않음', '형식 안내', 'P2'),
    ], ['에러', '상황', '처리', '우선순위'])

    doc.add_page_break()

    # ================================================================
    # SECTION G: 대화 흐름 Edge Cases
    # ================================================================
    doc.add_heading('6. Edge Case 처리 계획 - 대화 흐름', level=1)

    doc.add_heading('6.1 흐름 제어', level=2)

    add_table(doc, '흐름 제어 명령 (15종)', [
        ('"취소"', '작업 취소', '현재 작업 취소', 'P1'),
        ('"다시"', '재시도', '이전 작업 재실행', 'P1'),
        ('"처음부터"', '리셋', '세션 초기화', 'P2'),
        ('"뒤로"', '이전', '이전 상태 복원', 'P2'),
        ('"멈춰"', '일시 정지', '작업 대기', 'P2'),
        ('"계속"', '진행', '대기 작업 재개', 'P2'),
        ('"끝"', '종료', '대화 종료', 'P2'),
        ('"도움"', '도움말', '기능 안내', 'P2'),
        ('"히스토리"', '이력', '대화 이력', 'P3'),
    ], ['명령', '의미', '처리', '우선순위'])

    add_table(doc, '확인/선택 (10종)', [
        ('"응"/"네"', '긍정', '다음 단계 진행', 'P1'),
        ('"아니"/"싫어"', '부정', '대안 제시', 'P1'),
        ('"맞아"', '확인', '확정', 'P1'),
        ('"그래"', '동의', '진행', 'P1'),
        ('"글쎄"', '보류', '추가 질문', 'P2'),
        ('"1번"', '선택', '해당 항목 선택', 'P1'),
        ('"둘 다"', '복수 선택', '다중 선택', 'P1'),
        ('"아무거나"', '무관', '기본값/추천', 'P2'),
        ('"몰라"', '미정', '추가 안내', 'P2'),
    ], ['표현', '의미', '처리', '우선순위'])

    doc.add_heading('6.2 피드백', level=2)

    add_table(doc, '피드백 처리 (15종)', [
        ('"좋아"/"마음에 들어"', '긍정', '다음 단계 유도', 'P2'),
        ('"별로야"', '부정', '대안 제시', 'P1'),
        ('"이상해"', '불만', '사과 + 대안', 'P1'),
        ('"원한 게 아니야"', '오해', '재확인', 'P1'),
        ('"느려"', '속도 불만', '안내', 'P2'),
        ('"어려워"', 'UX 불만', '가이드', 'P2'),
        ('"왜?"', '이유 질문', '설명', 'P2'),
        ('"어떻게?"', '방법 질문', '가이드', 'P2'),
        ('"얼마?"', '가격 질문', '가격 안내', 'P1'),
    ], ['표현', '의미', '처리', '우선순위'])

    doc.add_heading('6.3 일반 대화', level=2)

    add_table(doc, '일반 대화 처리 (10종)', [
        ('"안녕"', '인사', '인사 응답', 'P3'),
        ('"고마워"', '감사', '응대', 'P3'),
        ('"뭐해?"', '상태', '서비스 소개', 'P3'),
        ('"뭘 할 수 있어?"', '기능', '기능 안내', 'P2'),
        ('"날씨 어때?"', '범위 외', '패션 서비스 유도', 'P3'),
        ('"너 AI야?"', 'AI 인식', 'AI 소개', 'P3'),
        ('"사람이랑 연결"', '상담원', '연결 안내', 'P2'),
        ('"버그야"', '오류 신고', '접수 안내', 'P2'),
    ], ['입력', '의도', '처리', '우선순위'])

    doc.add_page_break()

    # ================================================================
    # SECTION H: 특수 상황 Edge Cases
    # ================================================================
    doc.add_heading('7. Edge Case 처리 계획 - 특수 상황', level=1)

    doc.add_heading('7.1 타이밍/비동기', level=2)

    add_table(doc, '타이밍 이슈 (12종)', [
        ('빠른 연속 입력', '연타', '디바운싱', 'P1'),
        ('응답 전 추가 입력', '대기 중', '큐잉', 'P1'),
        ('피팅 대기 중', '다른 요청', '병렬 처리', 'P1'),
        ('세션 만료 직전', 'TTL 임박', '연장', 'P2'),
        ('장시간 대기', '30분 후', '복원', 'P2'),
        ('동시 요청', '같은 시점', '순차 처리', 'P1'),
        ('피크 타임', '높은 트래픽', '대기열', 'P2'),
        ('캐시 만료', 'TTL 경과', '새로 조회', 'P2'),
        ('토큰 갱신', '인증 만료', '자동 갱신', 'P1'),
    ], ['상황', '설명', '처리', '우선순위'])

    doc.add_heading('7.2 동시성', level=2)

    add_table(doc, '동시성 문제 (8종)', [
        ('재고 1개', '동시 주문', '선착순', 'P0'),
        ('동시 장바구니', '여러 기기', '동기화', 'P1'),
        ('세션 충돌', '다중 탭', '최신 우선', 'P2'),
        ('가격 변동', '조회 vs 주문', '최신 가격', 'P1'),
        ('상품 삭제', '보기 vs 삭제', '안내', 'P1'),
        ('동시 피팅', '같은 상품', '큐잉', 'P2'),
    ], ['상황', '설명', '처리', '우선순위'])

    doc.add_heading('7.3 사용자 상태', level=2)

    add_table(doc, '사용자 유형 (10종)', [
        ('신규', '첫 방문', '온보딩', 'P2'),
        ('재방문', '이력 있음', '개인화', 'P2'),
        ('로그인', '인증됨', '프로필 로드', 'P1'),
        ('비로그인', '게스트', '기본 기능만', 'P1'),
        ('세션 만료', '토큰 만료', '재로그인', 'P1'),
        ('동시 로그인', '다른 기기', '정책', 'P2'),
    ], ['유형', '설명', '처리', '우선순위'])

    doc.add_page_break()

    # ================================================================
    # 요약
    # ================================================================
    doc.add_heading('8. Edge Case 요약 통계', level=1)

    summary = '''
┌─────────────────────────────────────────────────────────────────────────────┐
│                     처리 가능 Edge Case 총 350+ 케이스                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [섹션별 케이스 수]                                                          │
│                                                                             │
│  2. 입력 처리 (150+)                                                         │
│     ├─ 텍스트 카테고리: 20종                                                 │
│     ├─ 텍스트 색상: 25종                                                     │
│     ├─ 텍스트 브랜드: 15종                                                   │
│     ├─ 텍스트 스타일/속성: 50종                                              │
│     ├─ 텍스트 가격: 10종                                                     │
│     ├─ 이미지 유형: 30종                                                     │
│     ├─ 이미지 품질: 20종                                                     │
│     ├─ 이미지 내용: 15종                                                     │
│     └─ 복합 입력: 30종                                                       │
│                                                                             │
│  3. 대화 컨텍스트 (55+)                                                      │
│     ├─ 직접 참조: 15종                                                       │
│     ├─ 시간 참조: 10종                                                       │
│     ├─ 상태 참조: 8종                                                        │
│     ├─ 복잡한 참조: 8종                                                      │
│     ├─ 멀티턴 대화: 15종                                                     │
│     └─ 조건부 요청: 10종                                                     │
│                                                                             │
│  4. 기능별 (80+)                                                             │
│     ├─ Search Agent: 12종                                                   │
│     ├─ Fitting Agent: 25종                                                  │
│     └─ Commerce Agent: 48종                                                 │
│                                                                             │
│  5. 시스템 에러 (30+)                                                        │
│     ├─ API 에러: 15종                                                        │
│     └─ 비즈니스 에러: 15종                                                   │
│                                                                             │
│  6. 대화 흐름 (35+)                                                          │
│     ├─ 흐름 제어: 15종                                                       │
│     ├─ 확인/선택: 10종                                                       │
│     ├─ 피드백: 15종                                                          │
│     └─ 일반 대화: 10종                                                       │
│                                                                             │
│  7. 특수 상황 (30+)                                                          │
│     ├─ 타이밍: 12종                                                          │
│     ├─ 동시성: 8종                                                           │
│     └─ 사용자 상태: 10종                                                     │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [우선순위별 분류]                                                           │
│                                                                             │
│  P0 (Critical - 필수): ~40개                                                 │
│     • 입력 검증 (빈 입력, 손상 이미지, 부적절 컨텐츠)                          │
│     • API 에러 처리 (Vision, Claude, OpenSearch, 피팅)                        │
│     • 비즈니스 에러 (품절, 결제 실패)                                         │
│     • 동시성 (재고 충돌)                                                     │
│                                                                             │
│  P1 (High - 사용자 경험): ~150개                                             │
│     • 모든 참조 표현 ("이거", "1번", "아까")                                  │
│     • 멀티턴 대화 패턴                                                       │
│     • 검색/피팅/장바구니/주문 기본 기능                                       │
│     • 확인/선택/피드백                                                       │
│     • 인증 상태                                                              │
│                                                                             │
│  P2 (Medium - 품질 향상): ~100개                                             │
│     • 이미지 품질 문제                                                       │
│     • 자연어 변형 (오타, 약어)                                               │
│     • 복잡한 참조 체인                                                       │
│     • 고급 검색/피팅 기능                                                    │
│     • 타이밍/세션 관리                                                       │
│                                                                             │
│  P3 (Low - 추가 개선): ~60개                                                 │
│     • 일반 대화                                                              │
│     • 캐시 최적화                                                            │
│     • 미지원 기능 안내                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
'''
    doc.add_paragraph(summary)

    doc.add_page_break()

    # ================================================================
    # 구현 로드맵
    # ================================================================
    doc.add_heading('9. 구현 로드맵', level=1)

    add_table(doc, '단계별 구현 계획', [
        ('1단계', 'P0 Critical', '입력 검증, API 에러 처리, 품절/결제', '필수'),
        ('2단계', 'P1 참조/대화', '참조 해석, 멀티턴 패턴', '필수'),
        ('3단계', 'P1 기능', 'Search/Fitting/Commerce 기본', '필수'),
        ('4단계', 'P2 품질', '이미지 품질, 자연어 변형', '권장'),
        ('5단계', 'P2 고급', '복잡한 참조, 고급 기능', '권장'),
        ('6단계', 'P3 추가', '일반 대화, 최적화', '선택'),
    ], ['단계', '범위', '내용', '우선순위'])

    # 저장
    output_path = '/Users/ijeong/Desktop/테커/AI_패션_어시스턴트_에이전트_개발_계획서.docx'
    doc.save(output_path)
    print(f"개발 계획서 v2 저장: {output_path}")
    print(f"파일 크기: {os.path.getsize(output_path):,} bytes")


if __name__ == '__main__':
    create_dev_plan_v2()
